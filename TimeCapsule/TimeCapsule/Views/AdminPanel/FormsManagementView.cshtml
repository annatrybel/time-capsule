@using TimeCapsule.Models.Dto;
@using TimeCapsule.Models.DatabaseModels;
@model List<CapsuleSectionDto>;

<div class="container">
    <!-- Breadcrumb -->
    <div class="row mt-3 mb-4">
        <div class="col-12">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a asp-controller="AdminPanel" asp-action="Index">Panel Administracyjny</a></li>
                    <li class="breadcrumb-item active" aria-current="page">Zarządzanie formularzem</li>
                </ol>
            </nav>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-md-8">
            <h2>Zarządzanie formularzem</h2>
        </div>
        <div class="col-md-4 text-md-end">
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addSectionModal">
                <i class="bi bi-plus-circle me-2"></i>Dodaj nową sekcję
            </button>
        </div>
    </div>

    <div class="accordion mb-4" id="capsuleTypesAccordion">
        @foreach (CapsuleType capsuleType in Enum.GetValues(typeof(CapsuleType)))
        {
            <div class="accordion-item">
                <h2 class="accordion-header" id="heading-type-@((int)capsuleType)">
                    <button class="accordion-button @(capsuleType == CapsuleType.Indywidualna ? "" : "collapsed")" type="button"
                            data-bs-toggle="collapse" data-bs-target="#collapse-type-@((int)capsuleType)"
                            aria-expanded="@(capsuleType == CapsuleType.Indywidualna ? "true" : "false")"
                            aria-controls="collapse-type-@((int)capsuleType)">
                        <strong>Kapsuła: @capsuleType</strong>
                    </button>
                </h2>
                <div id="collapse-type-@((int)capsuleType)" class="accordion-collapse collapse @(capsuleType == CapsuleType.Indywidualna ? "show" : "")"
                     aria-labelledby="heading-type-@((int)capsuleType)" data-bs-parent="#capsuleTypesAccordion">
                    <div class="accordion-body">
                        @{
                            var sectionsForType = Model.Where(s => s.CapsuleType == capsuleType).OrderBy(s => s.DisplayOrder).ToList();
                        }

                        @if (!sectionsForType.Any())
                        {
                            <div class="alert alert-info">
                                Brak sekcji dla tego typu kapsuły. Dodaj nową sekcję, aby rozpocząć.
                            </div>
                        }
                        else
                        {
                            <div class="accordion mb-3" id="sectionsAccordion-@((int)capsuleType)">
                                @foreach (var sectionItem in sectionsForType)
                                {
                                    var isFirstSection = sectionItem.DisplayOrder == sectionsForType.Min(s => s.DisplayOrder);

                                    <div class="accordion-item">
                                        <h2 class="accordion-header" id="heading-section-@(sectionItem.Id)">
                                            <button class="accordion-button @(isFirstSection ? "" : "collapsed")" type="button"
                                                    data-bs-toggle="collapse" data-bs-target="#collapse-section-@(sectionItem.Id)"
                                                    aria-expanded="@(isFirstSection ? "true" : "false")"
                                                    aria-controls="collapse-section-@(sectionItem.Id)">
                                                <strong>Sekcja @(sectionItem.DisplayOrder): @sectionItem.Name</strong>
                                            </button>
                                        </h2>
                                        <div id="collapse-section-@(sectionItem.Id)" class="accordion-collapse collapse @(isFirstSection ? "show" : "")"
                                             aria-labelledby="heading-section-@(sectionItem.Id)" data-bs-parent="#sectionsAccordion-@((int)capsuleType)">
                                            <div class="accordion-body">
                                                <table class="table">
                                                    <thead>
                                                        <tr>
                                                            <th style="width: 10%">#</th>
                                                            <th style="width: 80%">Treść pytania</th>
                                                            <th style="width: 10%">Akcje</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        @if (!sectionItem.Questions.Any())
                                                        {
                                                            <tr>
                                                                <td colspan="3" class="text-center">Brak pytań w tej sekcji</td>
                                                            </tr>
                                                        }
                                                        else
                                                        {
                                                            @foreach (var question in sectionItem.Questions.OrderBy(q => q.DisplayOrder))
                                                            {
                                                                <tr>
                                                                    <td>@question.DisplayOrder</td>
                                                                    <td>@question.QuestionText</td>
                                                                    <td>
                                                                        <button class="btn btn-sm btn-outline-secondary edit-question-btn"
                                                                                data-bs-toggle="modal"
                                                                                data-bs-target="#editQuestionModal"
                                                                                onclick="document.getElementById('editQuestionId').value=@question.Id; document.getElementById('editQuestionText').value='@Html.Raw(question.QuestionText.Replace("'", "\\'"))';">
                                                                            <i class="bi bi-pencil"></i>
                                                                        </button>
                                                                        <button type="button" class="btn btn-sm btn-outline-danger"
                                                                                data-bs-toggle="modal"
                                                                                data-bs-target="#deleteConfirmModal"
                                                                                onclick="document.getElementById('deleteForm').action='/AdminPanel/DeleteQuestion/@question.Id'">
                                                                            <i class="bi bi-trash"></i>
                                                                        </button>
                                                                    </td>
                                                                </tr>
                                                            }
                                                        }
                                                    </tbody>
                                                </table>

                                                <div class="text-center mt-3">
                                                    <button class="btn btn-outline-primary add-question-btn"
                                                            data-section-id="@sectionItem.Id"
                                                            data-bs-toggle="modal"
                                                            data-bs-target="#addQuestionModal">
                                                        <i class="bi bi-plus-lg me-1"></i> Dodaj pytanie
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                }
                            </div>
                        }
                    </div>
                </div>
            </div>
        }
    </div>
</div>

<partial name="~/Views/AdminPanel/_SectionModal.cshtml"></partial>
<partial name="~/Views/AdminPanel/_QuestionModal.cshtml"></partial>
<partial name="~/Views/AdminPanel/_UpdateQuesionModal.cshtml"></partial>
<partial name="_DeleteConfirmModal"></partial>

@section Scripts {
    <script>
        $(document).ready(function() {
            $('.add-question-btn').click(function() {
                const sectionId = $(this).data('section-id');
                $('#sectionId').val(sectionId);
            });
        });
    </script>
}
